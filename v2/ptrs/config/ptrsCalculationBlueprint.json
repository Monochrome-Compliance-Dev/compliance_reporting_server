{
  "version": "2.0.0",
  "name": "PTRS Calculation Blueprint (Generic)",
  "description": "Generic canonical field tags, fallbacks, derived formulas, and validation for PTRS v2. Source of truth used by all profiles (Veolia, Cosol, etc.).",
  "updatedAt": "2025-10-25T00:00:00Z",

  "profileHooks": ["synonyms", "fallbacks", "rowRules", "joins"],

  "bands": [
    { "id": "le20", "label": "0–20 days", "lte": 20 },
    { "id": "le30", "label": "21–30 days", "gt": 20, "lte": 30 },
    { "id": "le60", "label": "31–60 days", "gt": 30, "lte": 60 },
    { "id": "gt60", "label": ">60 days", "gt": 60 }
  ],

  "fields": [
    {
      "field": "paymentDate",
      "role": "core",
      "required": true,
      "type": "date",
      "fallbackChain": [
        "Payment Date",
        "Clearing Date",
        "Posting Date",
        "Document Date"
      ],
      "synonyms": ["payment date", "paid on", "clearing date", "posting date"]
    },
    {
      "field": "paymentAmount",
      "role": "core",
      "required": true,
      "type": "number",
      "synonyms": ["amount", "paid amount", "net amount"]
    },
    {
      "field": "payeeEntityName",
      "role": "core",
      "required": true,
      "type": "string",
      "synonyms": ["supplier", "vendor name", "payee name"]
    },
    {
      "field": "payeeEntityAbn",
      "role": "core",
      "required": true,
      "type": "string",
      "synonyms": ["abn", "supplier abn", "vendor abn", "tax id"]
    },
    {
      "field": "payerEntityName",
      "role": "core",
      "required": true,
      "type": "string",
      "synonyms": ["reporting entity", "payer name"]
    },
    {
      "field": "payerEntityAbn",
      "role": "core",
      "required": true,
      "type": "string",
      "synonyms": ["abn", "entity abn", "tax id"]
    },

    {
      "field": "supplyDate",
      "role": "recommended",
      "required": false,
      "type": "date",
      "fallbackChain": [
        "Supply Date",
        "Invoice Receipt Date",
        "Invoice Issue Date"
      ]
    },
    {
      "field": "invoiceIssueDate",
      "role": "supporting",
      "required": false,
      "type": "date",
      "synonyms": ["invoice issue date", "invoice date", "document date"]
    },
    {
      "field": "invoiceReceiptDate",
      "role": "supporting",
      "required": false,
      "type": "date",
      "synonyms": ["receipt date", "received date"]
    },
    {
      "field": "invoiceDueDate",
      "role": "recommended",
      "required": false,
      "type": "date",
      "fallbackFromTerms": true,
      "synonyms": ["due date"]
    },
    {
      "field": "paymentTermsDays",
      "role": "supporting",
      "required": false,
      "type": "number",
      "synonyms": ["payment terms", "terms days"]
    },
    {
      "field": "documentType",
      "role": "rule_input",
      "required": false,
      "type": "string",
      "synonyms": ["document type", "transaction type", "type"]
    },
    {
      "field": "documentReference",
      "role": "supporting",
      "required": false,
      "type": "string",
      "synonyms": ["invoice reference number", "invoice number", "reference"]
    },

    {
      "field": "isSmallBusiness",
      "role": "derived_external",
      "required": false,
      "type": "boolean",
      "source": "SBI"
    },

    {
      "field": "paymentTimeDays",
      "role": "derived",
      "type": "number",
      "dependsOn": [
        "paymentDate",
        "supplyDate",
        "invoiceReceiptDate",
        "invoiceIssueDate"
      ],
      "formula": "DATEDIFF(paymentDate, COALESCE(supplyDate, invoiceReceiptDate, invoiceIssueDate))",
      "notes": "Negative or null results should be excluded from banding/median."
    },
    {
      "field": "daysOverdue",
      "role": "derived",
      "type": "number",
      "dependsOn": [
        "paymentDate",
        "invoiceDueDate",
        "invoiceIssueDate",
        "paymentTermsDays"
      ],
      "formula": "DATEDIFF(paymentDate, COALESCE(invoiceDueDate, invoiceIssueDate + INTERVAL paymentTermsDays DAY))"
    }
  ],

  "fallbacks": {
    "paymentDate": [
      "Payment Date",
      "Clearing Date",
      "Posting Date",
      "Document Date"
    ],
    "supplyDate": ["Supply Date", "Invoice Receipt Date", "Invoice Issue Date"],
    "invoiceDueDate": [
      "Invoice Due Date",
      "Invoice Issue Date + paymentTermsDays"
    ],
    "payerEntityName": ["RUN_DEFAULT:payerEntityName"],
    "payerEntityAbn": ["RUN_DEFAULT:payerEntityAbn"]
  },

  "validation": {
    "excludeNegativePaymentTime": true,
    "excludeNullsForMedian": true,
    "coerceNumber": ["paymentAmount", "paymentTermsDays"],
    "coerceDate": [
      "paymentDate",
      "supplyDate",
      "invoiceIssueDate",
      "invoiceReceiptDate",
      "invoiceDueDate"
    ],
    "requireCoreFields": [
      "paymentDate",
      "paymentAmount",
      "payeeEntityName",
      "payeeEntityAbn",
      "payerEntityName",
      "payerEntityAbn"
    ]
  },

  "rowRules": [],

  "report": {
    "metrics": [
      "medianPaymentTime",
      "countByBand",
      "valueByBand",
      "pctPaidWithin20",
      "pctPaidWithin30",
      "totalIncluded",
      "valueExcluded"
    ],
    "bandsFrom": "paymentTimeDays",
    "bandThresholdsRef": "bands",
    "smallBusinessSubset": true
  }
}
